# osbuilder: onexstack æŠ€æœ¯æ ˆè„šæ‰‹æ¶å·¥å…·

**osbuilderï¼š** onexstack æŠ€æœ¯æ ˆä½¿ç”¨çš„ Go é¡¹ç›®å¼€å‘è„šæ‰‹æ¶ã€‚

## onexstack æŠ€æœ¯æ ˆä»‹ç»

onexstack æ˜¯ä¸€æ•´å¥— Go å¼€å‘æŠ€æœ¯æ ˆã€‚è¯¥æŠ€æœ¯æ ˆåŒ…æ‹¬äº†ä»¥ä¸‹å†…å®¹ï¼š
- å­¦ä¹ ç¤¾ç¾¤ï¼ˆæ¬¢è¿åŠ å…¥ï¼‰ï¼š[äº‘åŸç”Ÿ AI å®æˆ˜è¥](https://t.zsxq.com/5T0qC)
- é«˜è´¨é‡çš„ Go é¡¹ç›®ï¼š[ã€Œäº‘åŸç”Ÿ AI å®æˆ˜è¥ã€é¡¹ç›®ä»‹ç»](https://konglingfei.com/cloudai/project/cloudai.html)
- é«˜è´¨é‡çš„è¯¾ç¨‹ï¼š[ã€Œäº‘åŸç”Ÿ AI å®æˆ˜è¥ã€ä½“ç³»è¯¾ä»‹ç»](https://konglingfei.com/cloudai/catalog/cloudai.html)
- ä¸€ç³»åˆ—å¼€å‘è§„èŒƒï¼š[æŠ€æœ¯æ ˆç›¸å…³è§„èŒƒ](https://konglingfei.com/onex/convention/rest.html)
- ä¸€ç³»åˆ—å¼€å‘æ ‡å‡†åŒ…/å·¥å…·ï¼š[onexstack æ ‡å‡†åŒ–åŒ…](https://github.com/onexstack/onexstack)

onexstack æŠ€æœ¯æ ˆä¸­ï¼Œæ‰€æœ‰çš„ Web æœåŠ¡å™¨ç±»å‹çš„é¡¹ç›®éƒ½æ˜¯ä½¿ç”¨ `osbuilder` è„šæ‰‹æ¶è‡ªåŠ¨ç”Ÿæˆï¼Œä¾‹å¦‚ï¼š[miniblog](https://github.com/onexstack/miniblog)ã€‚

## osbuilder å·¥å…·ä»‹ç»

### osbuilder å·¥å…·ä»‹ç»

osbuilder æ˜¯ä¸€ä¸ª Go é¡¹ç›®å¼€å‘è„šæ‰‹æ¶ï¼Œå¯ä»¥ä¸€é”®ç”Ÿæˆä¸€ä¸ªç¬¦åˆ Go æœ€ä½³å®è·µçš„ Go é¡¹ç›®ã€‚è¯¥é¡¹ç›®é›†åˆäº†æˆ‘è¿‡å»å¯¹ Go é¡¹ç›®å¼€å‘ã€å¯¹æŠ€æœ¯ã€å¯¹æ¶æ„çš„æ€è€ƒå’Œç»éªŒã€‚ä¸ªäººæ„Ÿè§‰ç”Ÿæˆçš„ Go é¡¹ç›®ä»ä»£ç è´¨é‡ã€æ‰©å±•èƒ½åŠ›ã€çµæ´»æ€§ç­‰æ–¹é¢ï¼Œéƒ½å¤„åœ¨ä¸€ä¸ªå¾ˆä¸é”™çš„æ°´å¹³ã€‚æ˜¯ä¸ªéå¸¸å€¼å¾—å­¦ä¹ çš„ Go é¡¹ç›®æ„å»ºæ–¹å¼ã€‚


osbuilder å…·æœ‰ä»¥ä¸‹åŠŸèƒ½ç‰¹ç‚¹ï¼š
- æ”¯æŒä¸€æ¡å‘½ä»¤ç”Ÿæˆä¸€ä¸ªå¯ç›´æ¥è¿è¡Œçš„é«˜è´¨é‡ã€é«˜æ‰©å±•ã€æ ‡å‡†ã€ç¬¦åˆ Go å¼€å‘æœ€ä½³å®è·µçš„ Go é¡¹ç›®ï¼›
- æ”¯æŒä¸€æ¡å‘½ä»¤æ·»åŠ å¤šä¸ª REST èµ„æºçš„ä»£ç å®ç°ï¼›
- æ”¯æŒä¸åŒçš„ Web æ¡†æ¶ï¼Œä¾‹å¦‚ï¼š**gin**ã€**grpc**ã€kratosã€kitexã€hertzã€go-zeroã€echoã€irisç­‰ï¼›
- æ”¯æŒä¸åŒçš„å­˜å‚¨åç«¯ï¼Œä¾‹å¦‚ï¼š**memory**ã€**mariadb/mysql**ã€**sqlite**ã€**postgresql**ã€mongoã€etcdã€redis ç­‰ï¼›
- æ”¯æŒè‡ªåŠ¨æ·»åŠ å¥åº·æ£€æŸ¥æ¥å£ï¼›
- æ”¯æŒä¸€é”®å®ç°å¸¦ç”¨æˆ·ç®¡ç†ã€è®¤è¯ã€é‰´æƒåŠŸèƒ½çš„ Web æœåŠ¡ï¼›
- æ”¯æŒå…¨é“¾è·¯å¯è§‚æµ‹ï¼ŒåŒ…æ‹¬ï¼šTracingã€Metricsã€Logsï¼Œå¹¶æ”¯æŒç”Ÿæˆç¤ºä¾‹ Metrics ä»£ç ï¼›
- æ”¯æŒè‡ªåŠ¨æ³¨å†Œåˆ°ä¸åŒçš„æœåŠ¡ä¸­å¿ƒï¼Œä¾‹å¦‚ï¼š**polaris**ã€nacosã€consulã€eurekaï¼›
- æ”¯æŒç”Ÿæˆç¬¦åˆæœ€ä½³å®è·µçš„ Dockerfileï¼ŒåŒ…æ‹¬ï¼šdebug é•œåƒå’Œ distroless é•œåƒï¼›
- æ”¯æŒè‡ªåŠ¨ç”Ÿæˆé«˜è´¨é‡ã€ç»“æ„åŒ–çš„ Makefile æ–‡ä»¶ï¼Œå¹¶ä¸”è‡ªåŠ¨ç”Ÿæˆå¸¸ç”¨çš„ Makefile è§„åˆ™ï¼š
- æ”¯æŒæŒ‡å®š  Go æ¨¡å—åï¼›

ç”Ÿæˆçš„ Go é¡¹ç›®å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š
- é«˜è´¨é‡ã€é«˜æ‰©å±•ã€ç®€æ´ï¼›
- ç›®å½•ç»“æ„ã€ä»£ç æ¶æ„ã€ä»£ç å®ç°å‡ç¬¦åˆ Go ç¼–ç è§„èŒƒåŠæœ€ä½³å®è·µï¼›

### å®‰è£…

```bash
$ go install github.com/onexstack/osbuilder/cmd/osbuilder@latest
$ osbuilder version
```

## osbuilder è„šæ‰‹æ¶ä½¿ç”¨

osbuilder è„šæ‰‹æ¶å¯ä»¥ç”¨æ¥ç”Ÿäº§ä¸€ä¸ªæ–°çš„é¡¹ç›®ï¼Œä¹Ÿèƒ½å¤ŸåŸºäºå·²æœ‰çš„é¡¹ç›®æ·»åŠ æ–°çš„ REST èµ„æºã€‚


### 1. ç”Ÿæˆæ–°é¡¹ç›®

```bash
$ mkdir -p $GOPATH//src/github.com/onexstack
$ cd $GOPATH//src/github.com/onexstack
$ cat << EOF > project.yaml
scaffold: osbuilder
version: v0.1.0
metadata:
  # æŒ‡å®š Go æ¨¡å—åï¼Œä¹Ÿå¯ä»¥ä¸æŒ‡å®šï¼Œä½†æ˜¯ä¸€å®šè¦åœ¨ç±»ä¼¼ $GOPATH/src/github.com/onexstack ç›®å½•ä¸‹ç”Ÿæˆé¡¹ç›®
  # å› ä¸º osbuilder å·¥å…·ä¼šæ ¹æ®è·¯å¾„ï¼Œæ¨æµ‹ Go æ¨¡å—å
  modulePath: github.com/onexstack/osdemo
  shortDescription: Please update the short description of the binary file.
  longMessage: Please update the detailed description of the binary file.
  # é€‰æ‹©äºŒè¿›åˆ¶æ–‡ä»¶çš„éƒ¨ç½²å½¢å¼ã€‚å½“å‰æ”¯æŒ systemdã€dockerã€‚æœªæ¥ä¼šæ”¯æŒ kubernetesã€‚ä¼šç”Ÿæˆ Dockerfileã€Kubernetes YAML ç­‰èµ„æº
  # é»˜è®¤ docker
  deploymentMethod: docker
  image:
    # å½“æŒ‡å®š deploymentMethod ä¸º dockerã€kubernetes æ—¶ï¼Œæ„å»ºé•œåƒçš„ä»“åº“åœ°å€
    # é»˜è®¤ docker.io/_undefined
    registryPrefix: docker.io/colin404
    # æŒ‡å®š Dockerfile çš„ç”Ÿæˆæ¨¡å¼ã€‚å¯é€‰çš„æ¨¡å¼æœ‰ï¼š
    # - noneï¼šä¸ç”Ÿæˆ Dockerfileã€‚éœ€è¦è‡ªè¡Œå®ç° build/docker/<component_name>/Dockerfile æ–‡ä»¶ï¼›
    # - runtime-onlyï¼šä»…åŒ…å«è¿è¡Œæ—¶é˜¶æ®µï¼ˆé€‚åˆå·²æœ‰å¤–éƒ¨æ„å»ºäº§ç‰©ï¼‰ï¼Œé€‚åˆæœ¬åœ°è°ƒè¯•ï¼›
    # - multi-stageï¼šå¤šé˜¶æ®µæ„å»ºï¼ˆbuilder + runtimeï¼‰ï¼›
    # - combinedï¼šåŒæ—¶ç”Ÿæˆ multi-stageã€runtime-only 2 ç§ç±»å‹çš„ Dockerfileï¼š
    #   - multi-stageï¼šDockerfile åå­—ä¸º Dockerfile
    #   - runtime-onlyï¼šDockerfile åå­—ä¸º Dockerfile.runtime-only
    # é»˜è®¤ combined
    dockerfileMode: combined
    # æ˜¯å¦é‡‡ç”¨ distroless è¿è¡Œæ—¶é•œåƒã€‚å¦‚æœä¸é‡‡ç”¨ä¼šä½¿ç”¨ debian åŸºç¡€é•œåƒï¼Œå¦åˆ™ä½¿ç”¨ gcr.io/distroless/base-debian12:nonroot
    # - trueï¼šé‡‡ç”¨ gcr.io/distroless/base-debian12:nonroot åŸºç¡€é•œåƒã€‚ç”Ÿäº§ç¯å¢ƒå»ºè®®è®¾ç½®ä¸º trueï¼›
    # - falseï¼šé‡‡ç”¨ debian:bookworm åŸºç¡€é•œåƒã€‚æµ‹è¯•ç¯å¢ƒå»ºè®®è®¾ç½®ä¸º fasleï¼›
    # é»˜è®¤ false
    distroless: false
  # æ§åˆ¶ Makefile çš„ç”Ÿæˆæ–¹å¼ã€‚å½“å‰æ”¯æŒä»¥ä¸‹ 3 ç§ï¼š
  # - noneï¼šä¸ç”Ÿæˆ makefile
  # - structuredï¼šç”Ÿæˆå•ä¸ª makefile
  # - unstructuredï¼šç”Ÿæˆç»“æ„åŒ–çš„ makefile
  # é»˜è®¤ unstructured
  makefileMode: unstructured
  # é¡¹ç›®åˆ›å»ºè€…åå­—ï¼Œç”¨äºç”Ÿæˆç‰ˆæƒä¿¡æ¯
  author: å­”ä»¤é£
  # é¡¹ç›®åˆ›å»ºè€…é‚®ç®±ï¼Œç”¨äºç”Ÿæˆç‰ˆæƒä¿¡æ¯
  email: colin404@foxmail.com
# osbuilder æ”¯æŒå¤šç§åº”ç”¨ç±»å‹ã€‚å½“å‰ä»…æ”¯æŒ Web æœåŠ¡ç±»å‹
# æœªæ¥ä¼šæ”¯æŒï¼šå¼‚æ­¥ä»»åŠ¡ Job ç±»å‹ã€å‘½ä»¤è¡Œå·¥å…·ç±»å‹ã€å£°æ˜å¼APIæœåŠ¡å™¨ç±»å‹
webServers:
  - binaryName: mb-apiserver
    # Web Server ä½¿ç”¨çš„æ¡†æ¶ã€‚å½“å‰æ”¯æŒ ginã€grpc
    # æœªæ¥ä¼šæ”¯æŒ kratosã€grpc-gatewayã€go-zeroã€kitexã€hertzã€echoã€iris ç­‰
    # é»˜è®¤ gin
    webFramework: gin
    # å¯é€‰ï¼Œå½“ webFramework ä¸º grpc æ—¶æœ‰æ•ˆï¼ŒæŒ‡å®š grpc æœåŠ¡çš„åå­—
    grpcServiceName: APIServer
    # Web Server åç«¯ä½¿ç”¨çš„å­˜å‚¨ç±»å‹ã€‚å½“å‰æ”¯æŒ memoryã€mariadb/mysqlã€sqliteã€postgresql
    # æœªæ¥ä¼šæ”¯æŒ etcdã€redisã€mongo
    # é»˜è®¤ memory
    storageType: memory 
    # æ˜¯å¦æ·»åŠ å¥åº·æ£€æŸ¥æ¥å£
    # é»˜è®¤ false
    withHealthz: true
    # æ˜¯å¦æ·»åŠ ç”¨æˆ·é»˜è®¤ï¼Œå¼€å¯åï¼Œæœ‰å®Œæ•´çš„è®¤è¯ã€é‰´æƒæµç¨‹
    # é»˜è®¤ false
    withUser: false
    # æ˜¯å¦å¼€å¯ OpenTelemetry å…¨é“¾è·¯ç›‘æ§
    # é»˜è®¤ false
    withOTel: true
    # æ”¯æŒçš„æ³¨å†Œä¸­å¿ƒç±»å‹ï¼š
    # - noneï¼šä¸å®ç°æ³¨å†Œä¸­å¿ƒç›¸å…³ä»£ç ï¼ˆé»˜è®¤ noneï¼‰
    # - polarisï¼šæ”¯æŒåŒ—ææ˜Ÿæ³¨å†Œä¸­å¿ƒ
    # - eurekaï¼šæ”¯æŒ Eureka æ³¨å†Œä¸­å¿ƒ
    # - consul: æ”¯æŒ consul æ³¨å†Œä¸­å¿ƒ
    # - nacosï¼šæ”¯æŒ nacos æ³¨å†Œä¸­å¿ƒ
    # é»˜è®¤ none
    serviceRegistry: none
EOF
$ osbuilder create project --config project.yaml ./miniblog
...
ğŸº Project creation succeeded miniblog
ğŸ’» Use the following command to start the project ğŸ‘‡:
...
ğŸ¤ Thanks for using osbuilder.
ğŸ‘‰ Visit https://t.zsxq.com/5T0qC to learn how to develop miniblog project.
```

æ‰§è¡Œä¸Šè¿°å‘½ä»¤åï¼Œå¯ä»¥æ ¹æ®æç¤ºï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ¥éƒ¨ç½²å¹¶æµ‹è¯•æœåŠ¡ï¼š
```bash
$ cd ./miniblog # enter project directory
$ make deps # (Optional, executed when dependencies missing) Install tools required by project.
$ make protoc.apiserver # generate gRPC code
$ go mod tidy # tidy dependencies
$ go generate ./... # run all go:generate directives
$ make build BINS=mb-apiserver # build mb-apiserver
$ _output/platforms/linux/amd64/mb-apiserver # run the compiled server
$ curl http://127.0.0.1:5555/healthz # run health client to test the API
{"timestamp":"2025-08-24 13:23:19"}
```

å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ªé¡¹ç›®çš„ç”Ÿæˆè¿‡ç¨‹å¾ˆä¸æ»‘ï¼Œè€Œä¸”ç”Ÿæˆçš„é¡¹ç›®è·Ÿ [miniblog](https://github.com/onexstack/miniblog) ä¿æŒé«˜åº¦ä¸€è‡´ã€‚miniblog é¡¹ç›®æœ‰å®Œæ•´çš„å¼€å‘ä½“ç³»è¯¾ï¼Œæƒ³å­¦ä¹ çš„å¯ä»¥åŠ å…¥ [äº‘åŸç”Ÿ AI å®æˆ˜è¥](https://t.zsxq.com/5T0qC)ã€‚


> æç¤ºï¼šå¦‚æœæƒ³ç”Ÿäº§å¸¦è®¤è¯é‰´æƒçš„é¡¹ç›®å®ä¾‹ï¼Œéœ€è¦è®¾ç½®ï¼šwebserver[0].withUser ä¸º `true`ã€‚

### 2. åŸºäºå·²æœ‰é¡¹ç›®æ·»åŠ æ–°çš„ REST èµ„æº

```bash
# -b é€‰é¡¹æŒ‡å®šç»™ mb-apiserver èµ„æºæ·»åŠ æ–°çš„ REST èµ„æºï¼š
# - postï¼šæ–‡ç« 
# - commentï¼šè¯„è®º
# - tagï¼šæ ‡ç­¾	
# - followï¼šå…³æ³¨
# - followerï¼šç²‰ä¸
# - friendï¼šå¥½å‹
# - blockï¼šé»‘åå•
# - likeï¼šç‚¹èµ	
# - bookmarkï¼šæ”¶è—
# - shareï¼šåˆ†äº«
# - reportï¼šä¸¾æŠ¥
# - voteï¼šæŠ•ç¥¨
$ osbuilder create api -b mb-apiserver --kinds post,comment,tag,follow,follower,friend,block,like,bookmark,share,report,vote
```

ä¸Šè¿°å‘½ä»¤ä¼šæ·»åŠ  2 ä¸ªæ–°çš„ REST èµ„æºï¼šCronJobã€Jobã€‚æ¥ä¸‹æ¥ï¼Œä½ åªéœ€è¦æ·»åŠ æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å³å¯ã€‚

æ‰§è¡Œå®Œ `osbuilder` å‘½ä»¤ä¹‹åï¼Œä¼šæç¤ºå¦‚ä½•è¿›è¡Œç¼–è¯‘ã€‚æŒ‰æç¤ºç¼–è¯‘å¹¶æµ‹è¯•ï¼š
```bash
$ make protoc.apiserver 
$ make build BINS=mb-apiserver
$ _output/platforms/linux/amd64/mb-apiserver
# æç¤ºï¼šå¦‚æœæŒ‡å®šäº† withUser: trueï¼Œåˆ™éœ€è¦ç»™ HTTP å®¢æˆ·ç«¯æ·»åŠ è®¤è¯ä¿¡æ¯ï¼Œå¦åˆ™ä¼šæŠ¥ï¼šUnauthenticated é”™è¯¯
# åˆ›å»ºä¸€ä¸ªç©ºçš„æ–‡ç« ï¼ˆæ–‡ç« å†…å®¹ä¸ºç©ºï¼‰ï¼Œå…·ä½“è°ƒç”¨çš„æ¥å£ï¼Œå¯ä»¥æŸ¥çœ‹ scripts/startup-test.sh è„šæœ¬
$ sh scripts/startup-test.sh posts create '{}'
X-Trace-Id: 64c2835d72bb15fc07765de10e6283a1
-----------------------------
{
  "postID": "post-zhwu4c"
}
$ sh scripts/startup-test.sh posts get 'post-zhwu4c' # è·å–åˆšåˆ›å»ºçš„æ–‡ç« è¯¦æƒ…ï¼Œä¼ å…¥æ–‡ç«  ID
X-Trace-Id: 95c631460b60aa91ccb477380a8521ba
-----------------------------
{
  "post": {
    "postID": "post-zhwu4c",
    "createdAt": {
      "seconds": 1761728366
    },
    "updatedAt": {
      "seconds": 1761728366,
      "nanos": 834460375
    }
  }
}
```

### 3. æ ¹æ®éœ€è¦æ·»åŠ  REST èµ„æºçš„å…·ä½“ä¸šåŠ¡é€»è¾‘

æ¥ä¸‹æ¥ï¼Œåªéœ€è¦æ ¹æ®éœ€è¦å®ç° REST èµ„æºçš„å…·ä½“ä¸šåŠ¡é€»è¾‘å³å¯ã€‚ä¾‹å¦‚ ä¿®æ”¹ï¼š`internal/<component_name>/biz/v1/<rest_name>/<rest_name>.go`ã€‚
